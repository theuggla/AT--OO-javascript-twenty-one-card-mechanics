<template id="menuItemTemplate">
    <style>
        ::slotted(*) {
            display: block;
        }
        ::slotted([hide]) {
            display: none;
        }
    </style>
    <a href=""><slot name="menuitem"></slot></a>
    <ul id="subitems">
        <li><slot name="subitem"></slot></li>
    </ul>
</template>

<script>
    let menuTemplate = document.querySelector('link[href="/menu.html"]').import.querySelector("#menuItemTemplate");

    customElements.define('custom-menu-item', class extends HTMLElement {
        constructor() {
            super();

            //set up shadow dom styles
            let shadowRoot = this.attachShadow({mode: "open"});
            let instance = menuTemplate.content.cloneNode(true);
            shadowRoot.appendChild(instance);
        }

        connectedCallback() {
            if (this.hasAttribute('expand')) {
                makeExpandable(this);
            }
        }

        get subMenu() {
        }

        addSubMenuItem() {

        }
    });


    //helper functions
    function toggleSubMenu(context, target) {
        let label = target.getAttribute('label');
        let subs = Array.prototype.filter.call(context.children, (node) => {
            let nodeLabel = node.getAttribute('label');
            return nodeLabel === label && !(node.hasAttribute('expand'));
        });

        subs.forEach((item) => {
            if (item.hasAttribute('hide')) {
                item.removeAttribute('hide');
            } else {
                item.setAttribute('hide', '');
            }
        });
    }

    function makeExpandable(context) {
        let arrowExpand;
        let mouseExpand;
        let target;

        let events = function() {
            addEventListeners(this, 'focusin mousedown', ((event) => {
                target = event.target;
                if (!(target.hasAttribute('expand'))) {
                    target = target.parentElement;
                }

                if (target.hasAttribute('expand')) {
                    arrowExpand = true;
                    if (event.type === 'mousedown') {
                        mouseExpand = true;
                        toggleSubMenu(context, target);
                    }
                }
            }));
            addEventListeners(this, 'focusout mouseup', ((event) => {
                if (event.type === 'mouseup') {
                    if (mouseExpand) {
                        toggleSubMenu(context, target);
                        mouseExpand = false;
                    }
                } else {
                    toggleSubMenu(context, target)
                    arrowExpand = false;
                }
            }));
            addEventListeners(document, 'keydown', ((event) => {
                if (arrowExpand) {
                    switch (event.key) {
                        case 'ArrowLeft':
                            toggleSubMenu(context, target);
                            break;
                        case 'ArrowRight':
                            toggleSubMenu(context, target);
                            break;
                    }
                }

            }));
        };

        events();
    }

    function addEventListeners(element, events, handler) {
        events.split(' ').forEach(event => element.addEventListener(event, handler));
    }
</script>
