<template id="menuItemTemplate">
    <style>
        :host{
            position: relative;
        }
        ::slotted(*) {
            display: block;
        }
        ::slotted([hide]) {
            display: none;
        }
        ::slotted([slot='menuitem']) {
            width: 40%;
        }
        #subitems {
            padding-left: 10%;
            width: 40%;
            float: right;
        }
    </style>
    <slot name="menuitem"></slot>
    <div id="subitems">
        <slot name="subitem"></slot>
    </div>
</template>

<script>
    let menuTemplate = document.querySelector('link[href="/menu.html"]').import.querySelector("#menuItemTemplate");

    customElements.define('expandable-menu-item', class extends HTMLElement {
        constructor() {
            super();

            //set up shadow dom styles
            let shadowRoot = this.attachShadow({mode: "open"});
            let instance = menuTemplate.content.cloneNode(true);
            shadowRoot.appendChild(instance);
        }

        connectedCallback() {
            makeExpandable(this);
            //lägg in icon. länk? a? varför? vem?
        }

        get icon() {
            return this.getAttribute('icon');
        }

        set icon(src) {
            this.setAttribute('icon', src);
        }

        get subMenu() {
            let label = this.getAttribute('label');
            return Array.prototype.filter.call(this.querySelectorAll('[slot="subitem"]'), (node) => {
                let nodeLabel = node.getAttribute('label');
                return nodeLabel === label;
            });
        }
    });


    //helper functions
    function toggleSubMenu(item, show) {
        if (show) {
            item.subMenu.forEach((post) => {
                post.removeAttribute('hide');
            });
        } else {
            item.subMenu.forEach((post) => {
                post.setAttribute('hide', '');
            });
        }

    }

    function makeExpandable(item) {
        let arrowExpand;
        let mouseExpand;

        let events = function() {
            addEventListeners(item, 'focusin mousedown', ((event) => {
                    arrowExpand = true;
                    if (event.type === 'mousedown') {
                        mouseExpand = true;
                        toggleSubMenu(item, true);
                    }
            }));
            addEventListeners(item, 'focusout mouseup', ((event) => {
                if (event.type === 'mouseup') {
                    if (mouseExpand) {
                        toggleSubMenu(item);
                        mouseExpand = false;
                    }
                } else {
                    toggleSubMenu(item)
                    arrowExpand = false;
                }
            }));
            addEventListeners(document, 'keydown', ((event) => {
                if (arrowExpand) {
                    switch (event.key) {
                        case 'ArrowLeft':
                            toggleSubMenu(item);
                            break;
                        case 'ArrowRight':
                            toggleSubMenu(item, true);
                            break;
                    }
                }

            }));
        };

        events();
    }

    function addEventListeners(element, events, handler) {
        events.split(' ').forEach(event => element.addEventListener(event, handler));
    }
</script>
